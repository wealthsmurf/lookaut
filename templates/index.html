<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¸”ë¡ ë°©ì–´ ê²Œì„</title>
    <style>
        body { 
            margin: 0; overflow: hidden; background: #f4f4f4; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; font-family: 'Malgun Gothic', sans-serif;
            touch-action: manipulation; /* ë”ë¸”íƒ­ ì¤Œ ë°©ì§€ */
        }
        #game-wrapper { 
            position: relative; 
            width: 100%; 
            max-width: 500px; /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        canvas { 
            background: #ffffff; border: 3px solid #333; 
            cursor: pointer; box-shadow: 0 0 20px rgba(0,0,0,0.2);
            /* ëª¨ë°”ì¼ í™”ë©´ì— ê½‰ ì°¨ê²Œ ì¡°ì ˆ */
            width: 95vw; 
            height: auto;
            max-height: 80vh;
        }
        .panel {
            display: none; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); background: white; 
            padding: 20px; border-radius: 15px; border: 3px solid #333; 
            text-align: center; z-index: 100; box-shadow: 0 0 40px rgba(0,0,0,0.5); 
            width: 80%; /* ëª¨ë°”ì¼ ëŒ€ì‘ ë„ˆë¹„ */
            max-width: 300px;
        }
        button { 
            margin-top: 15px; padding: 12px 30px; background: #333; 
            color: white; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: bold; font-size: 16px;
        }
        
        #ad-content {
            margin: 15px 0; padding: 20px; background: #f9f9f9;
            border: 1px dashed #bbb; border-radius: 8px;
            font-size: 14px; color: #555; min-height: 80px;
            display: flex; align-items: center; justify-content: center;
        }

        #ui-panel {
            position: absolute; top: 10px; width: 95%;
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: none; z-index: 10;
        }
        .info-box {
            background: rgba(255, 255, 255, 0.9); padding: 5px 10px; 
            border-radius: 8px; border: 2px solid #333; font-weight: bold; font-size: 12px;
        }
        .tip-box { font-size: 10px; color: #666; text-align: center; }
        
        #sound-control {
            position: absolute; bottom: 10px; width: 100%;
            display: flex; justify-content: center; z-index: 20;
        }
        #mute-btn {
            background: #444; color: white; border: 2px solid #333;
            padding: 5px 15px; border-radius: 20px; font-size: 10px;
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="ui-panel">
            <div id="time-display" class="info-box">0.0s</div>
            <div class="tip-box"> ê´‘ê³  í´ë¦­ ì‹œ<br>ì†ë„ ê°ì†</div>
            <div id="best-display" class="info-box" style="color: #007bff;">Best: 0.0s</div>
        </div>
        
        <canvas id="gameCanvas"></canvas>

        <div id="sound-control">
            <button id="mute-btn" onclick="toggleMute(event)">ğŸµ ì†Œë¦¬ On</button>
        </div>

        <div id="start-overlay" class="panel" style="display: flex; flex-direction: column;">
            <h2>ë¸”ë¡ ë°©ì–´</h2>
            <p style="font-size: 14px;">í•˜ì–€ ë¸”ë¡ì´ ì„ ì— ë‹¿ìœ¼ë©´ íŒ¨ë°°!</p>
            <button onclick="startGame()">ê²Œì„ ì‹œì‘</button>
        </div>
        
        <div id="ad-modal" class="panel">
            <h3 style="margin-top: 0;">ê´‘ê³ </h3>
            <div id="ad-content">ì—¬ê¸°ì— ê´‘ê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
            <button onclick="closeAd()">ë‹«ê¸°</button>
        </div>

        <div id="game-over-panel" class="panel">
            <h2>GAME OVER</h2>
            <div id="final-time-val" style="font-size: 24px; font-weight: bold;">0.0s</div>
            <button onclick="location.reload()">ë‹¤ì‹œí•˜ê¸°</button>
        </div>
    </div>

    <script>
        const bgm = new Audio('Bgggm.mp3'); 
        bgm.loop = true; bgm.volume = 0.4;
        let isMuted = false, gameActive = false;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            if (isMuted || !gameActive) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'white') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'black') {
                osc.type = 'square'; osc.frequency.setValueAtTime(400, now);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(); osc.stop(now + 0.15);
            } else if (type === 'fail') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            }
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        // ë‚´ë¶€ í•´ìƒë„ëŠ” ê³ ì •í•˜ì—¬ ê²Œì„ ë¡œì§ ìœ ì§€
        canvas.width = 400; canvas.height = 650;
        const groundY = canvas.height - 60; 

        let blocks = [], particles = []; 
        let isPaused = false, isGameOver = false;
        let moveSpeed = 2.0; 
        let startTime = 0, pausedTimeTotal = 0, pauseStartedAt = 0;
        let bestTime = localStorage.getItem('bestSurvivalTime') || 0;
        document.getElementById('best-display').innerText = `Best: ${parseFloat(bestTime).toFixed(1)}s`;

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.size = Math.random() * 3 + 2;
                this.speedX = (Math.random() - 0.5) * 6;
                this.speedY = (Math.random() - 0.5) * 6 - 2; 
                this.gravity = 0.15; this.life = 1.0; 
            }
            update() { this.x += this.speedX; this.y += this.speedY; this.speedY += this.gravity; this.life -= 0.02; }
            draw() { ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, this.size, this.size); ctx.restore(); }
        }

        class Block {
            constructor(type, speed) {
                this.width = 60; this.height = 50;
                this.x = Math.random() * (canvas.width - this.width);
                this.y = -60; this.type = type; this.speed = speed;
            }
            draw() {
                ctx.save();
                ctx.fillStyle = this.type === 'white' ? '#FFFFFF' : '#000000';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.strokeRect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = this.type === 'white' ? '#333' : '#FFFFFF';
                [[15, 15], [45, 20], [20, 35], [40, 40]].forEach(p => { ctx.beginPath(); ctx.arc(this.x+p[0], this.y+p[1], 3, 0, Math.PI*2); ctx.fill(); });
                if(this.type === 'black') {
                    ctx.font = 'bold 16px sans-serif'; ctx.textAlign = 'center';
                    ctx.fillText("ê´‘ê³ ", this.x + 30, this.y + 32);
                }
                ctx.restore();
            }
            update() { if (!isPaused && !isGameOver && gameActive) this.y += this.speed; }
        }

        function spawnBlock() {
            if (!isPaused && !isGameOver && gameActive) {
                blocks.push(new Block(Math.random() > 0.3 ? 'white' : 'black', moveSpeed));
            }
            let nextSpawn = Math.max(300, 1500 - (moveSpeed * 100));
            setTimeout(spawnBlock, nextSpawn);
        }

        setInterval(() => { if (!isPaused && !isGameOver && gameActive) moveSpeed += 0.15; }, 1000);

        function update() {
            if (isGameOver || !gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!isPaused) {
                let elapsed = (Date.now() - startTime - pausedTimeTotal) / 1000;
                document.getElementById('time-display').innerText = `${elapsed.toFixed(1)}s`;
            }
            ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(canvas.width, groundY);
            ctx.strokeStyle = '#ff4d4d'; ctx.lineWidth = 4; ctx.stroke();
            
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update(); particles[i].draw();
                if (particles[i].life <= 0) particles.splice(i, 1);
            }
            for (let i = blocks.length - 1; i >= 0; i--) {
                blocks[i].update(); blocks[i].draw();
                if (blocks[i].type === 'white' && blocks[i].y + 50 >= groundY) {
                    isGameOver = true; playSfx('fail'); bgm.pause();
                    let finalTime = (Date.now() - startTime - pausedTimeTotal) / 1000;
                    document.getElementById('final-time-val').innerText = `${finalTime.toFixed(1)}s`;
                    if (finalTime > parseFloat(bestTime)) localStorage.setItem('bestSurvivalTime', finalTime);
                    document.getElementById('game-over-panel').style.display = 'block';
                    return;
                }
                if (blocks[i].y > canvas.height) blocks.splice(i, 1);
            }
            requestAnimationFrame(update);
        }

        // í„°ì¹˜/í´ë¦­ ê³µí†µ ì…ë ¥ ì²˜ë¦¬
        function handleInput(e) {
            if (!gameActive || isPaused || isGameOver) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            // ì‹¤ì œ í‘œì‹œë˜ëŠ” í¬ê¸°ì™€ ìº”ë²„ìŠ¤ ë‚´ë¶€ í•´ìƒë„ ë¹„ìœ¨ ê³„ì‚°
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const mouseX = (clientX - rect.left) * scaleX;
            const mouseY = (clientY - rect.top) * scaleY;

            for (let i = blocks.length - 1; i >= 0; i--) {
                const b = blocks[i];
                if (mouseX >= b.x && mouseX <= b.x + 60 && mouseY >= b.y && mouseY <= b.y + 50) {
                    if (b.type === 'white') {
                        playSfx('white');
                        for (let j = 0; j < 15; j++) particles.push(new Particle(b.x+30, b.y+25, '#CCCCCC'));
                        blocks.splice(i, 1);
                    } else {
                        playSfx('black');
                        for (let j = 0; j < 15; j++) particles.push(new Particle(b.x+30, b.y+25, '#333333'));
                        blocks.splice(i, 1);
                        isPaused = true; bgm.pause(); pauseStartedAt = Date.now();
                        setTimeout(() => { document.getElementById('ad-modal').style.display = 'block'; }, 100);
                    }
                    break;
                }
            }
        }

        canvas.addEventListener('touchstart', handleInput, {passive: false});
        canvas.addEventListener('mousedown', handleInput);

        function startGame() {
            document.getElementById('start-overlay').style.display = 'none';
            gameActive = true;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            bgm.play().catch(e => console.log("BGM ì¬ìƒ ë¶ˆê°€"));
            startTime = Date.now();
            spawnBlock();
            update();
        }

        function closeAd() {
            moveSpeed = Math.max(1.5, moveSpeed - 0.15);
            pausedTimeTotal += (Date.now() - pauseStartedAt);
            isPaused = false; 
            if (!isMuted) bgm.play().catch(() => {});
            document.getElementById('ad-modal').style.display = 'none';
        }

        function toggleMute(e) {
            e.stopPropagation();
            isMuted = !isMuted;
            bgm.muted = isMuted;
            document.getElementById('mute-btn').innerText = isMuted ? "ğŸ”‡ ì†Œë¦¬ Off" : "ğŸµ ì†Œë¦¬ On";
        }
    </script>
</body>
</html>
