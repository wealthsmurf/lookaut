<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¸”ë¡ ë°©ì–´</title>
    <style>
        body { 
            margin: 0; overflow: hidden; background: #f4f4f4; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; font-family: 'Malgun Gothic', sans-serif;
            touch-action: manipulation;
        }
        #game-wrapper { 
            position: relative; 
            width: 100%; 
            max-width: 400px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        canvas { 
            background: #ffffff; border: 3px solid #333; 
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            width: 90vw; 
            max-width: 360px;
            height: auto; 
            max-height: 70vh;
        }
        .panel {
            display: none; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); background: white; 
            padding: 20px; border-radius: 15px; border: 3px solid #333; 
            text-align: center; z-index: 100; box-shadow: 0 0 40px rgba(0,0,0,0.5); 
            width: 80%; max-width: 280px;
        }
        button { 
            padding: 12px 24px; background: #333; 
            color: white; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: bold; font-size: 16px;
            margin-top: 10px;
        }
        #ui-panel {
            position: absolute; top: 10px; 
            width: 90vw; 
            max-width: 360px;
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: none; z-index: 10;
        }
        .info-box {
            background: rgba(255, 255, 255, 0.9); padding: 5px 10px; 
            border-radius: 6px; border: 2px solid #333; font-weight: bold; font-size: 12px;
            pointer-events: auto;
        }
        .right-ui-group { display: flex; align-items: center; gap: 5px; }
        #mute-btn {
            background: #444; color: white; border: 2px solid #333;
            padding: 5px 8px; border-radius: 6px; font-size: 11px;
            cursor: pointer; pointer-events: auto;
        }
        .tip-box { font-size: 10px; color: #666; text-align: center; line-height: 1.2; font-weight: bold; }
        .bottom-nav {
            width: 100%; height: 60px; background: white;
            position: fixed; bottom: 0; display: flex;
            justify-content: center; align-items: center;
            border-top: 1px solid #ddd; z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="ui-panel">
            <div id="time-display" class="info-box">0.0s</div>
            <div class="tip-box">ğŸ’¡ ì ë°•ì´ íŒŒê´´!<br>ì  í•˜ë‚˜ëŠ” ì¡°ì‹¬!</div>
            <div class="right-ui-group">
                <div id="best-display" class="info-box" style="color: #007bff;">Best: 0.0s</div>
                <button id="mute-btn" onclick="toggleMute(event)">ğŸµ On</button>
            </div>
        </div>
        
        <canvas id="gameCanvas"></canvas>

        <div class="bottom-nav"> 
            <ins class="kakao_ad_area" style="display:none;"
                data-ad-unit = "DAN-8OJpo4T0Kc2rPuXZ"
                data-ad-width = "320"
                data-ad-height = "50"></ins>
            <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
        </div>

        <div id="start-overlay" class="panel" style="display: flex; flex-direction: column;">
            <h2 style="margin-top:0;">ë¸”ë¡ ë°©ì–´</h2>
            <p style="font-size: 14px; color: #444;">
                1. <b>í•˜ì–€ ì ë°•ì´</b> ë¸”ë¡ì„ í´ë¦­í•´ íŒŒê´´í•˜ì„¸ìš”!<br>
                2. ì  í•˜ë‚˜ ë¸”ë¡ì€ ì ë°•ì´ê°€ ì•„ë‹™ë‹ˆë‹¤!<br>
                3. <b>ê²€ì€ ê´‘ê³  ë¸”ë¡</b>ì€ ì†ë„ë¥¼ ëŠ¦ì¶°ì¤ë‹ˆë‹¤.<br>
                4. í•˜ì–€ ì ë°•ì´ê°€ ë°”ë‹¥ ì„ ì— ë‹¿ìœ¼ë©´ íŒ¨ë°°!
            </p>
            <button onclick="startGame()">ê²Œì„ ì‹œì‘</button>
        </div>
        
        <div id="ad-modal" class="panel">
            <h3 style="margin-top: 0;">ë³´ë„ˆìŠ¤ ê´‘ê³ </h3>
            <p style="font-size: 13px;">ê´‘ê³ ë¥¼ í™•ì¸í•˜ë©´ ë‚œì´ë„ê°€ ë‚®ì•„ì§‘ë‹ˆë‹¤.</p>
            <div id="ad-content" style="min-height: 60px; background: #eee; margin-bottom: 10px; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                <ins class="kakao_ad_area" style="display:none;"
                    data-ad-unit = "DAN-tTvpwiRyg3nxCPs1"
                    data-ad-width = "320"
                    data-ad-height = "50"></ins>
                <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
            </div>
            <button onclick="closeAd()">ë‹«ê¸° ë° ê³„ì†í•˜ê¸°</button>
        </div>

        <div id="game-over-panel" class="panel">
            <h2>GAME OVER</h2>
            <div id="final-time-val" style="font-size: 24px; font-weight: bold; margin-bottom: 15px;">0.0s</div>
            <button onclick="location.reload()">ë‹¤ì‹œí•˜ê¸°</button>
        </div>
    </div>

    <script>
        // --- 1. ì˜¤ë””ì˜¤ ì„¤ì • ---
        const bgm = new Audio('Bgggm.mp3'); 
        bgm.loop = true; 
        bgm.volume = 0.5;

        let isMuted = localStorage.getItem('gameMuted') === 'true';
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function syncMuteSettings() {
            bgm.muted = isMuted;
            const btn = document.getElementById('mute-btn');
            if (btn) btn.innerText = isMuted ? "ğŸ”‡ Off" : "ğŸµ On";
        }

        function playSfx(type) {
            if (isMuted || !gameActive) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'white') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'black') {
                osc.type = 'square'; osc.frequency.setValueAtTime(400, now);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(); osc.stop(now + 0.15);
            } else if (type === 'fail') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            }
        }

        // --- 2. ê²Œì„ ë³€ìˆ˜ ì„¤ì • ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 400; canvas.height = 650;
        const groundY = canvas.height - 60; 

        let blocks = [], particles = []; 
        let isPaused = false, isGameOver = false, gameActive = false;
        let moveSpeed = 2.3; 
        let startTime = 0, pausedTimeTotal = 0, pauseStartedAt = 0;
        let bestTime = localStorage.getItem('bestSurvivalTime') || 0;

        document.getElementById('best-display').innerText = `Best: ${parseFloat(bestTime).toFixed(1)}s`;

        // --- 3. í´ë˜ìŠ¤ ì •ì˜ ---
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.size = Math.random() * 3 + 2;
                this.speedX = (Math.random() - 0.5) * 6;
                this.speedY = (Math.random() - 0.5) * 6 - 2; 
                this.gravity = 0.15; this.life = 1.0; 
            }
            update() { this.x += this.speedX; this.y += this.speedY; this.speedY += this.gravity; this.life -= 0.02; }
            draw() { ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, this.size, this.size); ctx.restore(); }
        }

        class Block {
            constructor(type, speed) {
                this.width = 60; this.height = 50;
                this.x = Math.random() * (canvas.width - this.width);
                this.y = -60; this.type = type; this.speed = speed;
            }
            draw() {
                ctx.save();
                // ë°°ê²½ìƒ‰
                ctx.fillStyle = (this.type === 'white' || this.type === 'whiteDot') ? '#FFFFFF' : '#000000';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.strokeRect(this.x, this.y, this.width, this.height);
                
                // ì ë°•ì´/í…ìŠ¤íŠ¸ ìƒ‰ìƒ
                ctx.fillStyle = (this.type === 'white' || this.type === 'whiteDot') ? '#333' : '#FFFFFF';
                
                if (this.type === 'whiteDot') {
                    // ì  í•˜ë‚˜ (ì¡°ì‹¬í•´ì•¼ í•  ë¸”ë¡)
                    ctx.beginPath(); ctx.arc(this.x + 30, this.y + 25, 5, 0, Math.PI*2); ctx.fill();
                } else if (this.type === 'white') {
                    // ì  ì—¬ëŸ¬ê°œ (íŒŒê´´ ëŒ€ìƒ)
                    [[15, 15], [45, 20], [20, 35], [40, 40]].forEach(p => { 
                        ctx.beginPath(); ctx.arc(this.x+p[0], this.y+p[1], 3, 0, Math.PI*2); ctx.fill(); 
                    });
                } else if (this.type === 'black') {
                    // ê´‘ê³  ë¸”ë¡
                    ctx.font = 'bold 15px sans-serif'; ctx.textAlign = 'center';
                    ctx.fillText("ê´‘ê³ ", this.x + 30, this.y + 32);
                }
                ctx.restore();
            }
            update() { if (!isPaused && !isGameOver && gameActive) this.y += this.speed; }
        }

        // --- 4. ê²Œì„ ë¡œì§ ---
        function spawnBlock() {
            if (!isPaused && !isGameOver && gameActive) {
                let elapsed = (Date.now() - startTime - pausedTimeTotal) / 1000;
                let rand = Math.random();
                let newType = 'white';
                
                // í™•ë¥  ì„¤ì •
                if (elapsed > 15 && rand < 0.15) newType = 'whiteDot'; // 15ì´ˆ ì´í›„ ì  í•˜ë‚˜ ë¸”ë¡ ë“±ì¥
                else if (rand > 0.8) newType = 'black'; // ê´‘ê³  ë¸”ë¡ í™•ë¥ 
                
                blocks.push(new Block(newType, moveSpeed));
            }
            let nextSpawn = Math.max(200, 700 - (moveSpeed * 100)); 
            setTimeout(spawnBlock, nextSpawn);
        }

        setInterval(() => { if (!isPaused && !isGameOver && gameActive) moveSpeed += 0.1; }, 1000);

        function update() {
            if (isGameOver || !gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!isPaused) {
                let elapsed = (Date.now() - startTime - pausedTimeTotal) / 1000;
                document.getElementById('time-display').innerText = `${elapsed.toFixed(1)}s`;
            }

            // ë¹¨ê°„ ë°”ë‹¥ ì„ 
            ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(canvas.width, groundY);
            ctx.strokeStyle = '#ff4d4d'; ctx.lineWidth = 4; ctx.stroke();
            
            // íŒŒí‹°í´ ì—…ë°ì´íŠ¸
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update(); particles[i].draw();
                if (particles[i].life <= 0) particles.splice(i, 1);
            }

            // ë¸”ë¡ ì—…ë°ì´íŠ¸ ë° ì¶©ëŒ ê°ì§€
            for (let i = blocks.length - 1; i >= 0; i--) {
                const b = blocks[i];
                b.update(); b.draw();

                // í•˜ì–€ ì ë°•ì´ ë¸”ë¡ì´ ì„ ì— ë‹¿ìœ¼ë©´ ê²Œì„ ì˜¤ë²„
                if (b.type === 'white' && b.y + b.height >= groundY) {
                    endGame();
                    return;
                }
                
                // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì‚­ì œ
                if (b.y > canvas.height) blocks.splice(i, 1);
            }
            requestAnimationFrame(update);
        }

        function handleInput(e) {
            if (!gameActive || isPaused || isGameOver) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
            const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
            const mouseX = (clientX - rect.left) * scaleX;
            const mouseY = (clientY - rect.top) * scaleY;
            const hitPadding = 20;

            for (let i = blocks.length - 1; i >= 0; i--) {
                const b = blocks[i];
                if (mouseX >= b.x - hitPadding && mouseX <= b.x + b.width + hitPadding &&
                    mouseY >= b.y - hitPadding && mouseY <= b.y + b.height + hitPadding) {
                    
                    if (b.type === 'white') {
                        // íŒŒê´´ ëŒ€ìƒ ë¸”ë¡
                        playSfx('white');
                        for (let j = 0; j < 12; j++) particles.push(new Particle(b.x+30, b.y+25, '#CCCCCC'));
                        blocks.splice(i, 1);
                    } else if (b.type === 'black') {
                        // ê´‘ê³  ë¸”ë¡ (ë‚œì´ë„ í•˜ë½)
                        playSfx('black');
                        blocks.splice(i, 1);
                        isPaused = true; 
                        bgm.pause(); 
                        pauseStartedAt = Date.now();
                        document.getElementById('ad-modal').style.display = 'block';
                    } else if (b.type === 'whiteDot') {
                        // ì  í•˜ë‚˜ ë¸”ë¡ (í´ë¦­ ì‹œ íš¨ê³¼ë§Œ ë°œìƒ, íŒŒê´´ëŠ” ê°€ëŠ¥í•˜ê²Œ ì„¤ì •)
                        playSfx('white');
                        for (let j = 0; j < 5; j++) particles.push(new Particle(b.x+30, b.y+25, '#ffcc00'));
                        blocks.splice(i, 1);
                    }
                    break; 
                }
            }
        }

        // --- 5. ì œì–´ í•¨ìˆ˜ ---
        function startGame() {
            document.getElementById('start-overlay').style.display = 'none';
            gameActive = true;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            bgm.muted = isMuted;
            if (!isMuted) bgm.play().catch(e => console.log("Audio play failed:", e));
            
            startTime = Date.now();
            spawnBlock();
            update();
        }

        function endGame() {
            isGameOver = true; 
            playSfx('fail'); 
            bgm.pause();
            let finalTime = (Date.now() - startTime - pausedTimeTotal) / 1000;
            document.getElementById('final-time-val').innerText = `${finalTime.toFixed(1)}s`;
            if (finalTime > parseFloat(bestTime)) localStorage.setItem('bestSurvivalTime', finalTime);
            document.getElementById('game-over-panel').style.display = 'block';
        }

        function closeAd() {
            moveSpeed = Math.max(2.0, moveSpeed - 0.4); // ì†ë„ ê°ì†Œ ë³´ìƒ
            pausedTimeTotal += (Date.now() - pauseStartedAt);
            isPaused = false; 
            if (!isMuted) bgm.play().catch(() => {});
            document.getElementById('ad-modal').style.display = 'none';
        }

        function toggleMute(e) {
            if(e) e.stopPropagation();
            isMuted = !isMuted;
            localStorage.setItem('gameMuted', isMuted);
            bgm.muted = isMuted;
            if (isMuted) bgm.pause();
            else if (gameActive && !isPaused) bgm.play().catch(() => {});
            document.getElementById('mute-btn').innerText = isMuted ? "ğŸ”‡ Off" : "ğŸµ On";
        }

        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
        canvas.addEventListener('mousedown', handleInput);
        window.onload = syncMuteSettings;
    </script>
</body>
</html>
