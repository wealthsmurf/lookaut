<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¸”ë¡ ë°©ì–´ ê²Œì„</title>
    <style>
        body { 
            margin: 0; overflow: hidden; background: #f4f4f4; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; font-family: 'Malgun Gothic', sans-serif;
            touch-action: manipulation;
        }
        #game-wrapper { 
            position: relative; 
            width: 100%; 
            max-width: 400px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        canvas { 
            background: #ffffff; border: 3px solid #333; 
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            width: 80vw; 
            max-width: 360px;
            height: auto; 
            max-height: 75vh;
        }
        .panel {
            display: none; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); background: white; 
            padding: 20px; border-radius: 15px; border: 3px solid #333; 
            text-align: center; z-index: 100; box-shadow: 0 0 40px rgba(0,0,0,0.5); 
            width: 75%; max-width: 280px;
        }
        button { 
            padding: 10px 20px; background: #333; 
            color: white; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: bold; font-size: 14px;
        }

        #ui-panel {
            position: absolute; top: 15px; 
            width: 80vw; 
            max-width: 360px;
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: none; z-index: 10;
        }
        .info-box {
            background: rgba(255, 255, 255, 0.9); padding: 4px 8px; 
            border-radius: 6px; border: 2px solid #333; font-weight: bold; font-size: 11px;
            pointer-events: auto;
        }
        .right-ui-group { display: flex; align-items: center; gap: 4px; }
        
        #mute-btn {
            background: #444; color: white; border: 2px solid #333;
            padding: 4px 6px; border-radius: 6px; font-size: 9px;
            cursor: pointer; pointer-events: auto;
        }
        .tip-box { font-size: 9px; color: #666; text-align: center; line-height: 1.1; }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="ui-panel">
            <div id="time-display" class="info-box">0.0s</div>
            <div class="tip-box">ğŸ’¡ ì  í•˜ë‚˜ ë°•íŒ í•˜ì–€ ë¸”ë¡ë„<br>ê´‘ê³ ê°€ ë‚˜ì˜µë‹ˆë‹¤!</div>
            <div class="right-ui-group">
                <div id="best-display" class="info-box" style="color: #007bff;">Best: 0.0s</div>
                <button id="mute-btn" onclick="toggleMute(event)">ğŸµ On</button>
            </div>
        </div>
        
        <canvas id="gameCanvas"></canvas>

        <div id="start-overlay" class="panel" style="display: flex; flex-direction: column;">
            <h2 style="font-size: 20px;">ë¸”ë¡ ë°©ì–´</h2>
            <p style="font-size: 13px;">í•˜ì–€ ë¸”ë¡ì„ íŒŒê´´í•˜ì„¸ìš”!!<br>(20ì´ˆ í›„ ì‹ ê·œ ë¸”ë¡ ë“±ì¥)</p>
            <button onclick="startGame()">ê²Œì„ ì‹œì‘</button>
        </div>
        
        <div id="ad-modal" class="panel">
            <h3 style="margin-top: 0; font-size: 18px;">ê´‘ê³ </h3>
            <div id="ad-content" style="font-size: 14px; min-height: 60px; display: flex; align-items: center; justify-content: center; background: #eee; margin-bottom: 10px; border-radius: 5px;">ì—¬ê¸°ì— ê´‘ê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
            <button onclick="closeAd()">ë‹«ê¸°</button>
        </div>

        <div id="game-over-panel" class="panel">
            <h2 style="font-size: 20px;">GAME OVER</h2>
            <div id="final-time-val" style="font-size: 22px; font-weight: bold; margin-bottom: 10px;">0.0s</div>
            <button onclick="location.reload()">ë‹¤ì‹œí•˜ê¸°</button>
        </div>
    </div>

    <script>
        const bgm = new Audio('Bgggm.mp3'); 
        bgm.loop = true; bgm.volume = 1.00;
        let isMuted = false, gameActive = false;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            if (isMuted || !gameActive) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'white') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'black') {
                osc.type = 'square'; osc.frequency.setValueAtTime(400, now);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(); osc.stop(now + 0.15);
            } else if (type === 'fail') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            }
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 400; canvas.height = 650;
        const groundY = canvas.height - 60; 

        let blocks = [], particles = []; 
        let isPaused = false, isGameOver = false;
        let moveSpeed = 2.0; 
        let startTime = 0, pausedTimeTotal = 0, pauseStartedAt = 0;
        let bestTime = localStorage.getItem('bestSurvivalTime') || 0;
        document.getElementById('best-display').innerText = `Best: ${parseFloat(bestTime).toFixed(1)}s`;

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.size = Math.random() * 3 + 2;
                this.speedX = (Math.random() - 0.5) * 6;
                this.speedY = (Math.random() - 0.5) * 6 - 2; 
                this.gravity = 0.15; this.life = 1.0; 
            }
            update() { this.x += this.speedX; this.y += this.speedY; this.speedY += this.gravity; this.life -= 0.02; }
            draw() { ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, this.size, this.size); ctx.restore(); }
        }

        class Block {
            constructor(type, speed) {
                this.width = 60; this.height = 50;
                this.x = Math.random() * (canvas.width - this.width);
                this.y = -60; this.type = type; this.speed = speed;
            }
            draw() {
                ctx.save();
                // ë°”íƒ•ìƒ‰
                ctx.fillStyle = (this.type === 'white' || this.type === 'whiteDot') ? '#FFFFFF' : '#000000';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.strokeRect(this.x, this.y, this.width, this.height);
                
                // ì  ê·¸ë¦¬ê¸°
                ctx.fillStyle = (this.type === 'white' || this.type === 'whiteDot') ? '#333' : '#FFFFFF';
                
                if (this.type === 'whiteDot') {
                    // 20ì´ˆ í›„ ë“±ì¥í•˜ëŠ” ì  í•˜ë‚˜ ë¸”ë¡
                    ctx.beginPath(); ctx.arc(this.x + 30, this.y + 25, 4, 0, Math.PI*2); ctx.fill();
                } else if (this.type === 'white' || this.type === 'black') {
                    // ì¼ë°˜ ë¸”ë¡ë“¤ (ì  4ê°œ)
                    [[15, 15], [45, 20], [20, 35], [40, 40]].forEach(p => { 
                        ctx.beginPath(); ctx.arc(this.x+p[0], this.y+p[1], 3, 0, Math.PI*2); ctx.fill(); 
                    });
                }

                if(this.type === 'black') {
                    ctx.font = 'bold 16px sans-serif'; ctx.textAlign = 'center';
                    ctx.fillText("ê´‘ê³ ", this.x + 30, this.y + 32);
                }
                ctx.restore();
            }
            update() { if (!isPaused && !isGameOver && gameActive) this.y += this.speed; }
        }

        function spawnBlock() {
            if (!isPaused && !isGameOver && gameActive) {
                let elapsed = (Date.now() - startTime - pausedTimeTotal) / 1000;
                let rand = Math.random();
                
                let newType = 'white';
                if (elapsed > 20 && rand < 0.2) { 
                    // 20ì´ˆê°€ ì§€ë‚¬ê³  20% í™•ë¥ ë¡œ ì  í•˜ë‚˜ í•˜ì–€ ë¸”ë¡ ìƒì„±
                    newType = 'whiteDot';
                } else if (rand > 0.7) { 
                    // ì¼ë°˜ì ì¸ ê²€ì€ ë¸”ë¡ í™•ë¥ 
                    newType = 'black';
                }
                
                blocks.push(new Block(newType, moveSpeed));
            }
            let nextSpawn = Math.max(200, 1000 - (moveSpeed * 100));
            setTimeout(spawnBlock, nextSpawn);
        }

        setInterval(() => { if (!isPaused && !isGameOver && gameActive) moveSpeed += 0.10; }, 1000);

        function update() {
            if (isGameOver || !gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!isPaused) {
                let elapsed = (Date.now() - startTime - pausedTimeTotal) / 1000;
                document.getElementById('time-display').innerText = `${elapsed.toFixed(1)}s`;
            }
            ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(canvas.width, groundY);
            ctx.strokeStyle = '#ff4d4d'; ctx.lineWidth = 4; ctx.stroke();
            
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update(); particles[i].draw();
                if (particles[i].life <= 0) particles.splice(i, 1);
            }
            for (let i = blocks.length - 1; i >= 0; i--) {
                blocks[i].update(); blocks[i].draw();
                // í•˜ì–€ìƒ‰ ê³„ì—´ ë¸”ë¡ì´ ë°”ë‹¥ì— ë‹¿ìœ¼ë©´ ê²Œì„ ì˜¤ë²„
                if ((blocks[i].type === 'white' || blocks[i].type === 'whiteDot') && blocks[i].y + 50 >= groundY) {
                    isGameOver = true; playSfx('fail'); bgm.pause();
                    let finalTime = (Date.now() - startTime - pausedTimeTotal) / 1000;
                    document.getElementById('final-time-val').innerText = `${finalTime.toFixed(1)}s`;
                    if (finalTime > parseFloat(bestTime)) localStorage.setItem('bestSurvivalTime', finalTime);
                    document.getElementById('game-over-panel').style.display = 'block';
                    return;
                }
                if (blocks[i].y > canvas.height) blocks.splice(i, 1);
            }
            requestAnimationFrame(update);
        }

        function handleInput(e) {
            if (!gameActive || isPaused || isGameOver) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const mouseX = (clientX - rect.left) * scaleX;
            const mouseY = (clientY - rect.top) * scaleY;

            for (let i = blocks.length - 1; i >= 0; i--) {
                const b = blocks[i];
                if (mouseX >= b.x && mouseX <= b.x + 60 && mouseY >= b.y && mouseY <= b.y + 50) {
                    if (b.type === 'white') {
                        playSfx('white');
                        for (let j = 0; j < 15; j++) particles.push(new Particle(b.x+30, b.y+25, '#CCCCCC'));
                        blocks.splice(i, 1);
                    } else if (b.type === 'black' || b.type === 'whiteDot') {
                        // ê²€ì€ ë¸”ë¡ í˜¹ì€ ì  í•˜ë‚˜ í•˜ì–€ ë¸”ë¡ì€ ê´‘ê³  ì‹¤í–‰
                        playSfx('black');
                        const pColor = b.type === 'black' ? '#333333' : '#CCCCCC';
                        for (let j = 0; j < 15; j++) particles.push(new Particle(b.x+30, b.y+25, pColor));
                        blocks.splice(i, 1);
                        isPaused = true; bgm.pause(); pauseStartedAt = Date.now();
                        setTimeout(() => { document.getElementById('ad-modal').style.display = 'block'; }, 100);
                    }
                    break;
                }
            }
        }

        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
        canvas.addEventListener('mousedown', handleInput);

        function startGame() {
            document.getElementById('start-overlay').style.display = 'none';
            gameActive = true;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            bgm.play().catch(() => {});
            startTime = Date.now();
            spawnBlock();
            update();
        }

        function closeAd() {
            moveSpeed = Math.max(1.5, moveSpeed - 0.15);
            pausedTimeTotal += (Date.now() - pauseStartedAt);
            isPaused = false; 
            if (!isMuted) bgm.play().catch(() => {});
            document.getElementById('ad-modal').style.display = 'none';
        }

        function toggleMute(e) {
            e.stopPropagation();
            isMuted = !isMuted;
            bgm.muted = isMuted;
            document.getElementById('mute-btn').innerText = isMuted ? "ğŸ”‡ Off" : "ğŸµ On";
        }
    </script>
</body>
</html>
