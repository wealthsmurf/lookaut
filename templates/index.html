<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¸”ë¡ ë°©ì–´ - ì™„ë²½ ìŒì†Œê±° ì €ì¥</title>
    <style>
        body { 
            margin: 0; overflow: hidden; background: #f4f4f4; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; font-family: 'Malgun Gothic', sans-serif;
            touch-action: manipulation;
        }
        #game-wrapper { 
            position: relative; 
            width: 100%; 
            max-width: 400px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        canvas { 
            background: #ffffff; border: 3px solid #333; 
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            width: 80vw; 
            max-width: 360px;
            height: auto; 
            max-height: 75vh;
        }
        .panel {
            display: none; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); background: white; 
            padding: 20px; border-radius: 15px; border: 3px solid #333; 
            text-align: center; z-index: 100; box-shadow: 0 0 40px rgba(0,0,0,0.5); 
            width: 75%; max-width: 280px;
        }
        button { 
            padding: 10px 20px; background: #333; 
            color: white; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: bold; font-size: 14px;
        }
        #ui-panel {
            position: absolute; top: 15px; 
            width: 80vw; 
            max-width: 360px;
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: none; z-index: 10;
        }
        .info-box {
            background: rgba(255, 255, 255, 0.9); padding: 4px 8px; 
            border-radius: 6px; border: 2px solid #333; font-weight: bold; font-size: 11px;
            pointer-events: auto;
        }
        .right-ui-group { display: flex; align-items: center; gap: 4px; }
        #mute-btn {
            background: #444; color: white; border: 2px solid #333;
            padding: 4px 6px; border-radius: 6px; font-size: 9px;
            cursor: pointer; pointer-events: auto;
        }
        .tip-box { font-size: 9px; color: #666; text-align: center; line-height: 1.1; }
        .bottom-nav {
            width: 100%; height: 65px; background: white;
            position: fixed; bottom: 0; display: flex;
            justify-content: space-around; align-items: center;
            border-top: 1px solid #ddd; font-size: 24px; color: #007bff; z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="ui-panel">
            <div id="time-display" class="info-box">0.0s</div>
            <div class="tip-box">ğŸ’¡ ì  ì—¬ëŸ¬ê°œ í•˜ì–€ ë¸”ë¡ë§Œ<br>ë¹¨ê°„ì„ ì— ë‹¿ìœ¼ë©´ íŒ¨ë°°!</div>
            <div class="right-ui-group">
                <div id="best-display" class="info-box" style="color: #007bff;">Best: 0.0s</div>
                <button id="mute-btn" onclick="toggleMute(event)">ğŸµ On</button>
            </div>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        <div class="bottom-nav"> 
            <div>ğŸ </div>
            <div>ğŸ†</div>
            <div>âš™ï¸</div>
        </div>

        <div id="start-overlay" class="panel" style="display: flex; flex-direction: column;">
            <h2 style="font-size: 20px;">ë¸”ë¡ ë°©ì–´</h2>
            <p style="font-size: 13px;">í•˜ì–€ ì ë°•ì´ ë¸”ë¡ì„ íŒŒê´´í•˜ì„¸ìš”!<br>ì†Œë¦¬ ì„¤ì •ì€ ìˆ˜ë™ìœ¼ë¡œ ì¼¤ ë•Œê¹Œì§€ ìœ ì§€ë©ë‹ˆë‹¤.</p>
            <button onclick="startGame()">ê²Œì„ ì‹œì‘</button>
        </div>
        
        <div id="ad-modal" class="panel">
            <h3 style="margin-top: 0; font-size: 18px;">ê´‘ê³ </h3>
            <div id="ad-content" style="font-size: 14px; min-height: 60px; display: flex; align-items: center; justify-content: center; background: #eee; margin-bottom: 10px; border-radius: 5px;">ì ì‹œ íœ´ì‹ ì‹œê°„...</div>
            <button onclick="closeAd()">ë‹«ê¸°</button>
        </div>

        <div id="game-over-panel" class="panel">
            <h2 style="font-size: 20px;">GAME OVER</h2>
            <div id="final-time-val" style="font-size: 22px; font-weight: bold; margin-bottom: 10px;">0.0s</div>
            <button onclick="location.reload()">ë‹¤ì‹œí•˜ê¸°</button>
        </div>
    </div>

    <script>
        // 1. ì†Œë¦¬ íŒŒì¼ ì„ ì–¸ ë° ì´ˆê¸° ì„¤ì •
        const bgm = new Audio('Bgggm.mp3'); 
        bgm.loop = true; 
        bgm.volume = 1.00;

        // 2. [í•µì‹¬] í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ê° ìŒì†Œê±° ìƒíƒœ ë¡œë“œ
        let isMuted = localStorage.getItem('gameMuted') === 'true';
        
        // í˜ì´ì§€ ëœ¨ìë§ˆì ì‹¤í–‰ë˜ëŠ” UI ì—…ë°ì´íŠ¸
        function syncMuteSettings() {
            bgm.muted = isMuted;
            const btn = document.getElementById('mute-btn');
            if (btn) btn.innerText = isMuted ? "ğŸ”‡ Off" : "ğŸµ On";
        }
        syncMuteSettings();

        // 3. ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ (íš¨ê³¼ìŒìš©)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSfx(type) {
            // ì†Œë¦¬ êº¼ì ¸ìˆìœ¼ë©´ ì•„ì˜ˆ í•¨ìˆ˜ ì‹¤í–‰ ì•ˆí•¨
            if (isMuted || !gameActive) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'white') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'black') {
                osc.type = 'square'; osc.frequency.setValueAtTime(400, now);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(); osc.stop(now + 0.15);
            } else if (type === 'fail') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            }
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 400; canvas.height = 650;
        const groundY = canvas.height - 60; 

        let blocks = [], particles = []; 
        let isPaused = false, isGameOver = false, gameActive = false;
        let moveSpeed = 2.3; 
        let startTime = 0, pausedTimeTotal = 0, pauseStartedAt = 0;
        let bestTime = localStorage.getItem('bestSurvivalTime') || 0;
        document.getElementById('best-display').innerText = `Best: ${parseFloat(bestTime).toFixed(1)}s`;

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.size = Math.random() * 3 + 2;
                this.speedX = (Math.random() - 0.5) * 6;
                this.speedY = (Math.random() - 0.5) * 6 - 2; 
                this.gravity = 0.15; this.life = 1.0; 
            }
            update() { this.x += this.speedX; this.y += this.speedY; this.speedY += this.gravity; this.life -= 0.02; }
            draw() { ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, this.size, this.size); ctx.restore(); }
        }

        class Block {
            constructor(type, speed) {
                this.width = 60; this.height = 50;
                this.x = Math.random() * (canvas.width - this.width);
                this.y = -60; this.type = type; this.speed = speed;
            }
            draw() {
                ctx.save();
                ctx.fillStyle = (this.type === 'white' || this.type === 'whiteDot') ? '#FFFFFF' : '#000000';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.strokeRect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = (this.type === 'white' || this.type === 'whiteDot') ? '#333' : '#FFFFFF';
                
                if (this.type === 'whiteDot') {
                    ctx.beginPath(); ctx.arc(this.x + 30, this.y + 25, 4, 0, Math.PI*2); ctx.fill();
                } else {
                    [[15, 15], [45, 20], [20, 35], [40, 40]].forEach(p => { 
                        ctx.beginPath(); ctx.arc(this.x+p[0], this.y+p[1], 3, 0, Math.PI*2); ctx.fill(); 
                    });
                }
                if(this.type === 'black') {
                    ctx.font = 'bold 16px sans-serif'; ctx.textAlign = 'center';
                    ctx.fillText("ê´‘ê³ ", this.x + 30, this.y + 32);
                }
                ctx.restore();
            }
            update() { if (!isPaused && !isGameOver && gameActive) this.y += this.speed; }
        }

        function spawnBlock() {
            if (!isPaused && !isGameOver && gameActive) {
                let elapsed = (Date.now() - startTime - pausedTimeTotal) / 1000;
                let rand = Math.random();
                let newType = 'white';
                if (elapsed > 20 && rand < 0.2) newType = 'whiteDot';
                else if (rand > 0.75) newType = 'black';
                
                blocks.push(new Block(newType, moveSpeed));
            }
            let nextSpawn = Math.max(140, 650 - (moveSpeed * 90)); 
            setTimeout(spawnBlock, nextSpawn);
        }

        setInterval(() => { if (!isPaused && !isGameOver && gameActive) moveSpeed += 0.11; }, 1000);

        function update() {
            if (isGameOver || !gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!isPaused) {
                let elapsed = (Date.now() - startTime - pausedTimeTotal) / 1000;
                document.getElementById('time-display').innerText = `${elapsed.toFixed(1)}s`;
            }

            ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(canvas.width, groundY);
            ctx.strokeStyle = '#ff4d4d'; ctx.lineWidth = 4; ctx.stroke();
            
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update(); particles[i].draw();
                if (particles[i].life <= 0) particles.splice(i, 1);
            }

            for (let i = blocks.length - 1; i >= 0; i--) {
                const b = blocks[i];
                b.update(); b.draw();

                if (b.type === 'white' && b.y + b.height >= groundY) {
                    isGameOver = true; 
                    playSfx('fail'); 
                    bgm.pause();
                    let finalTime = (Date.now() - startTime - pausedTimeTotal) / 1000;
                    document.getElementById('final-time-val').innerText = `${finalTime.toFixed(1)}s`;
                    if (finalTime > parseFloat(bestTime)) localStorage.setItem('bestSurvivalTime', finalTime);
                    document.getElementById('game-over-panel').style.display = 'block';
                    return;
                }
                if (b.y > canvas.height) blocks.splice(i, 1);
            }
            requestAnimationFrame(update);
        }

        function handleInput(e) {
            if (!gameActive || isPaused || isGameOver) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
            const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
            const mouseX = (clientX - rect.left) * scaleX;
            const mouseY = (clientY - rect.top) * scaleY;
            const hitPadding = 15;

            for (let i = blocks.length - 1; i >= 0; i--) {
                const b = blocks[i];
                if (mouseX >= b.x - hitPadding && mouseX <= b.x + b.width + hitPadding &&
                    mouseY >= b.y - hitPadding && mouseY <= b.y + b.height + hitPadding) {
                    
                    if (b.type === 'white') {
                        playSfx('white');
                        for (let j = 0; j < 15; j++) particles.push(new Particle(b.x+30, b.y+25, '#CCCCCC'));
                        blocks.splice(i, 1);
                    } else {
                        playSfx('black');
                        const pColor = b.type === 'black' ? '#333333' : '#CCCCCC';
                        for (let j = 0; j < 15; j++) particles.push(new Particle(b.x+30, b.y+25, pColor));
                        blocks.splice(i, 1);
                        isPaused = true; 
                        bgm.pause(); 
                        pauseStartedAt = Date.now();
                        setTimeout(() => { document.getElementById('ad-modal').style.display = 'block'; }, 100);
                    }
                    break; 
                }
            }
        }

        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
        canvas.addEventListener('mousedown', handleInput);

        function startGame() {
            document.getElementById('start-overlay').style.display = 'none';
            gameActive = true;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            // [ì¤‘ìš”] ì‹œì‘ ì‹œ í˜„ì¬ ìŒì†Œê±° ìƒíƒœë¥¼ ë‹¤ì‹œ í™•ì¸
            bgm.muted = isMuted;
            if (!isMuted) {
                bgm.play().catch(e => console.log("Audio play failed:", e));
            }
            
            startTime = Date.now();
            spawnBlock();
            update();
        }

        function closeAd() {
            moveSpeed = Math.max(1.5, moveSpeed - 0.25);
            pausedTimeTotal += (Date.now() - pauseStartedAt);
            isPaused = false; 
            
            // ê´‘ê³  ë‹«ì„ ë•Œë„ ìŒì†Œê±° ì²´í¬
            if (!isMuted) bgm.play().catch(() => {});
            
            document.getElementById('ad-modal').style.display = 'none';
        }

        function toggleMute(e) {
            if(e) e.stopPropagation();
            isMuted = !isMuted;
            
            // ìƒíƒœ ì˜êµ¬ ì €ì¥
            localStorage.setItem('gameMuted', isMuted);
            
            bgm.muted = isMuted;
            if (isMuted) {
                bgm.pause();
            } else {
                // ê²Œì„ ì¤‘ì´ê±°ë‚˜ ì¼ì‹œì •ì§€ê°€ ì•„ë‹ ë•Œë§Œ ì¬ìƒ
                if (gameActive && !isPaused) bgm.play().catch(() => {});
            }
            
            document.getElementById('mute-btn').innerText = isMuted ? "ğŸ”‡ Off" : "ğŸµ On";
        }

        // ì‹¤í–‰ ì‹œ UI ë™ê¸°í™”
        window.onload = syncMuteSettings;
    </script>
</body>
</html>
