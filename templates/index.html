<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¸”ë¡ ë°©ì–´</title>
    <style>
        body { 
            margin: 0; overflow: hidden; background: #f4f4f4; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; font-family: 'Malgun Gothic', sans-serif;
            touch-action: manipulation;
        }
        #game-wrapper { 
            position: relative; 
            width: 100%; 
            max-width: 400px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        canvas { 
            background: #ffffff; border: 3px solid #333; 
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            width: 80vw; 
            max-width: 360px;
            height: auto; 
            max-height: 70vh;
        }
        .panel {
            display: none; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); background: white; 
            padding: 20px; border-radius: 15px; border: 3px solid #333; 
            text-align: center; z-index: 100; box-shadow: 0 0 40px rgba(0,0,0,0.5); 
            width: 75%; max-width: 280px;
        }
        button { 
            padding: 12px 24px; background: #333; 
            color: white; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: bold; font-size: 15px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        #ui-panel {
            position: absolute; top: 15px; 
            width: 85vw; 
            max-width: 360px;
            display: flex; justify-content: space-between; align-items: center;
            pointer-events: none; z-index: 10;
        }
        .info-box {
            background: rgba(255, 255, 255, 0.9); padding: 4px 10px; 
            border-radius: 6px; border: 2px solid #333; font-weight: bold; font-size: 12px;
            pointer-events: auto;
        }
        .tip-box { font-size: 10px; color: #666; text-align: center; line-height: 1.2; font-weight: bold; }
        .right-ui-group { display: flex; align-items: center; gap: 5px; }
        #mute-btn {
            background: #444; color: white; border: 2px solid #333;
            padding: 4px 8px; border-radius: 6px; font-size: 10px;
            cursor: pointer; pointer-events: auto;
        }
        .bottom-nav {
            width: 100%; height: 60px; background: white;
            position: fixed; bottom: 0; display: flex;
            justify-content: center; align-items: center;
            border-top: 1px solid #ddd; z-index: 1000;
        }
        /* ê´‘ê³  ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .ad-loader { font-size: 12px; color: #999; position: absolute; }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="ui-panel">
            <div id="time-display" class="info-box">0.0s</div>
            <div class="tip-box">í•˜ì–€ ë¸”ë¡(ì  4ê°œ)ë§Œ<br>ì§€í‚¤ì„¸ìš”!</div>
            <div class="right-ui-group">
                <div id="best-display" class="info-box" style="color: #007bff;">Best: 0.0s</div>
                <button id="mute-btn" onclick="toggleMute(event)">ğŸµ On</button>
            </div>
        </div>
        
        <canvas id="gameCanvas"></canvas>

        <div class="bottom-nav"> 
            <ins class="kakao_ad_area" style="display:none;"
                data-ad-unit = "DAN-8OJpo4T0Kc2rPuXZ"
                data-ad-width = "320"
                data-ad-height = "50"></ins>
            <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
        </div>

        <div id="start-overlay" class="panel" style="display: flex; flex-direction: column;">
            <h2 style="margin-top:0;">ğŸ›¡ï¸ ë¸”ë¡ ë°©ì–´</h2>
            <p style="font-size: 13px; color: #444; line-height: 1.5;">
                1. <b>í•˜ì–€ ì ë°•ì´</b> ë¸”ë¡ì„ í´ë¦­í•´ íŒŒê´´í•˜ì„¸ìš”!<br>

                2. ì  í•˜ë‚˜ ë¸”ë¡ì€ ê·¸ëƒ¥ ê´‘ê³ ê°€ ë‚˜ì˜µë‹ˆë‹¤!<br>

                3. <b>ê²€ì€ ê´‘ê³  ë¸”ë¡</b>ì€ ë‚œì´ë„ë¥¼ ë‚®ì¶°ì¤ë‹ˆë‹¤.<br>

                4. í•˜ì–€ ì ë°•ì´ê°€ ë°”ë‹¥ ì„ ì— ë‹¿ìœ¼ë©´ íŒ¨ë°°!
            </p>
            <button onclick="startGame()">ê²Œì„ ì‹œì‘</button>
        </div>
        
        <div id="ad-modal" class="panel">
            <h3 style="margin-top: 0; font-size: 18px;">ì ì‹œ íœ´ì‹!</h3>
            <div id="ad-content" style="min-height: 60px; display: flex; align-items: center; justify-content: center; background: #eee; margin-bottom: 15px; border-radius: 8px; position: relative; overflow: hidden;">
                <span class="ad-loader">ê´‘ê³  ë¡œë”© ì¤‘...</span>
                <div id="kakao-ad-container"></div>
            </div>
            <button onclick="closeAd()">ê´‘ê³  ë‹«ê³  ê³„ì†í•˜ê¸°</button>
        </div>

        <div id="game-over-panel" class="panel">
            <h2 style="color: #ff4d4d;">GAME OVER</h2>
            <div id="final-time-val" style="font-size: 28px; font-weight: bold; margin-bottom: 15px;">0.0s</div>
            <button onclick="location.reload()">ë‹¤ì‹œ ë„ì „</button>
        </div>
    </div>

    <script>
        // 1. ì˜¤ë””ì˜¤ ì„¤ì •
        const bgm = new Audio('Bgggm.mp3'); 
        bgm.loop = true; 
        bgm.volume = 1.0;

        let isMuted = localStorage.getItem('gameMuted') === 'true';
        function syncMuteSettings() {
            bgm.muted = isMuted;
            const btn = document.getElementById('mute-btn');
            if (btn) btn.innerText = isMuted ? "ğŸ”‡ Off" : "ğŸµ On";
        }
        syncMuteSettings();

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSfx(type) {
            if (isMuted || !gameActive) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'white') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'black') {
                osc.type = 'square'; osc.frequency.setValueAtTime(400, now);
                gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(); osc.stop(now + 0.15);
            } else if (type === 'fail') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            }
        }

        // 2. ê²Œì„ ë³€ìˆ˜
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 400; canvas.height = 650;
        const groundY = canvas.height - 60; 

        let blocks = [], particles = []; 
        let isPaused = false, isGameOver = false, gameActive = false;
        let moveSpeed = 2.3; 
        let startTime = 0, pausedTimeTotal = 0, pauseStartedAt = 0;
        let bestTime = localStorage.getItem('bestSurvivalTime') || 0;
        document.getElementById('best-display').innerText = `Best: ${parseFloat(bestTime).toFixed(1)}s`;

        // ë¸”ë¡/íŒŒí‹°í´ í´ë˜ìŠ¤ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.size = Math.random() * 3 + 2;
                this.speedX = (Math.random() - 0.5) * 6;
                this.speedY = (Math.random() - 0.5) * 6 - 2; 
                this.gravity = 0.15; this.life = 1.0; 
            }
            update() { this.x += this.speedX; this.y += this.speedY; this.speedY += this.gravity; this.life -= 0.02; }
            draw() { ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, this.size, this.size); ctx.restore(); }
        }

        class Block {
            constructor(type, speed) {
                this.width = 60; this.height = 50;
                this.x = Math.random() * (canvas.width - this.width);
                this.y = -60; this.type = type; this.speed = speed;
            }
            draw() {
                ctx.save();
                ctx.fillStyle = (this.type === 'white' || this.type === 'whiteDot') ? '#FFFFFF' : '#000000';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.strokeRect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = (this.type === 'white' || this.type === 'whiteDot') ? '#333' : '#FFFFFF';
                
                if (this.type === 'whiteDot') {
                    ctx.beginPath(); ctx.arc(this.x + 30, this.y + 25, 4, 0, Math.PI*2); ctx.fill();
                } else {
                    [[15, 15], [45, 20], [20, 35], [40, 40]].forEach(p => { 
                        ctx.beginPath(); ctx.arc(this.x+p[0], this.y+p[1], 3, 0, Math.PI*2); ctx.fill(); 
                    });
                }
                if(this.type === 'black') {
                    ctx.font = 'bold 14px sans-serif'; ctx.textAlign = 'center';
                    ctx.fillText("ê´‘ê³ ", this.x + 30, this.y + 32);
                }
                ctx.restore();
            }
            update() { if (!isPaused && !isGameOver && gameActive) this.y += this.speed; }
        }

        // 3. ê²Œì„ ì—”ì§„ í•¨ìˆ˜
        function spawnBlock() {
            if (!isPaused && !isGameOver && gameActive) {
                let elapsed = (Date.now() - startTime - pausedTimeTotal) / 1000;
                let rand = Math.random();
                let newType = 'white';
                if (elapsed > 20 && rand < 0.2) newType = 'whiteDot';
                else if (rand > 0.82) newType = 'black'; // í™•ë¥  ì‚´ì§ ì¡°ì •
                
                blocks.push(new Block(newType, moveSpeed));
            }
            let nextSpawn = Math.max(160, 680 - (moveSpeed * 95)); 
            setTimeout(spawnBlock, nextSpawn);
        }

        setInterval(() => { if (!isPaused && !isGameOver && gameActive) moveSpeed += 0.1; }, 1000);

        function update() {
            if (isGameOver || !gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!isPaused) {
                let elapsed = (Date.now() - startTime - pausedTimeTotal) / 1000;
                document.getElementById('time-display').innerText = `${elapsed.toFixed(1)}s`;
            }

            // ë°ë“œë¼ì¸ (ë¹¨ê°„ì„ )
            ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(canvas.width, groundY);
            ctx.strokeStyle = '#ff4d4d'; ctx.lineWidth = 4; ctx.stroke();
            
            particles.forEach((p, i) => { p.update(); p.draw(); if(p.life <=0) particles.splice(i,1); });

            for (let i = blocks.length - 1; i >= 0; i--) {
                const b = blocks[i];
                b.update(); b.draw();

                if (b.type === 'white' && b.y + b.height >= groundY) {
                    gameOver();
                    return;
                }
                if (b.y > canvas.height) blocks.splice(i, 1);
            }
            requestAnimationFrame(update);
        }

        function gameOver() {
            isGameOver = true; 
            playSfx('fail'); 
            bgm.pause();
            let finalTime = (Date.now() - startTime - pausedTimeTotal) / 1000;
            document.getElementById('final-time-val').innerText = `${finalTime.toFixed(1)}s`;
            if (finalTime > parseFloat(bestTime)) localStorage.setItem('bestSurvivalTime', finalTime);
            document.getElementById('game-over-panel').style.display = 'block';
        }

        function handleInput(e) {
            if (!gameActive || isPaused || isGameOver) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
            const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
            const mouseX = (clientX - rect.left) * scaleX;
            const mouseY = (clientY - rect.top) * scaleY;
            
            // í„°ì¹˜ íŒì • ë²”ìœ„ ë„‰ë„‰í•˜ê²Œ ìˆ˜ì •
            const hitPadding = 20;

            for (let i = blocks.length - 1; i >= 0; i--) {
                const b = blocks[i];
                if (mouseX >= b.x - hitPadding && mouseX <= b.x + b.width + hitPadding &&
                    mouseY >= b.y - hitPadding && mouseY <= b.y + b.height + hitPadding) {
                    
                    if (b.type === 'white') {
                        playSfx('white');
                        for (let j = 0; j < 12; j++) particles.push(new Particle(b.x+30, b.y+25, '#CCCCCC'));
                        blocks.splice(i, 1);
                    } else {
                        showAd();
                        const pColor = b.type === 'black' ? '#333333' : '#CCCCCC';
                        for (let j = 0; j < 12; j++) particles.push(new Particle(b.x+30, b.y+25, pColor));
                        blocks.splice(i, 1);
                    }
                    break; 
                }
            }
        }

        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
        canvas.addEventListener('mousedown', handleInput);

        // 4. ê´‘ê³  ë° ì œì–´ ë¡œì§ ë³´ì™„
        function showAd() {
            isPaused = true; 
            bgm.pause(); 
            pauseStartedAt = Date.now();
            document.getElementById('ad-modal').style.display = 'block';

            // [ë³´ì™„] ê´‘ê³  ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ë° ì¬ìƒì„± (ê´‘ê³  ê°±ì‹ ìš©)
            const container = document.getElementById('kakao-ad-container');
            container.innerHTML = `
                <ins class="kakao_ad_area" style="display:none;"
                    data-ad-unit = "DAN-tTvpwiRyg3nxCPs1"
                    data-ad-width = "320"
                    data-ad-height = "50"></ins>
            `;
            // ì¹´ì¹´ì˜¤ ê´‘ê³  ìŠ¤í¬ë¦½íŠ¸ ì¬í˜¸ì¶œ
            const script = document.createElement('script');
            script.src = "//t1.daumcdn.net/kas/static/ba.min.js";
            script.async = true;
            container.appendChild(script);
        }

        function closeAd() {
            moveSpeed = Math.max(1.8, moveSpeed - 0.4); // ì†ë„ë¥¼ ë” ì‹œì›í•˜ê²Œ ì¤„ì„
            pausedTimeTotal += (Date.now() - pauseStartedAt);
            isPaused = false; 
            if (!isMuted) bgm.play().catch(() => {});
            document.getElementById('ad-modal').style.display = 'none';
        }

        function startGame() {
            document.getElementById('start-overlay').style.display = 'none';
            gameActive = true;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            bgm.muted = isMuted;
            if (!isMuted) bgm.play().catch(e => console.log("Audio fail:", e));
            startTime = Date.now();
            spawnBlock();
            update();
        }

        function toggleMute(e) {
            if(e) e.stopPropagation();
            isMuted = !isMuted;
            localStorage.setItem('gameMuted', isMuted);
            bgm.muted = isMuted;
            if (isMuted) bgm.pause();
            else if (gameActive && !isPaused) bgm.play().catch(() => {});
            document.getElementById('mute-btn').innerText = isMuted ? "ğŸ”‡ Off" : "ğŸµ On";
        }

        window.onload = syncMuteSettings;
    </script>
</body>
</html>



